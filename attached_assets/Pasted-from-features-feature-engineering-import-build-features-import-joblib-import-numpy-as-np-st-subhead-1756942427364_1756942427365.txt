from features.feature_engineering import build_features
import joblib
import numpy as np

st.subheader("Backtest using best model probabilities")
thr = st.slider("Prob. threshold (long when â‰¥ threshold)", 0.50, 0.70, 0.55, 0.01)

if st.button("Run backtest (best model)"):
    # 1) pick one symbol (stock or crypto)
    symbols_s = [s.strip().upper() for s in stocks.split(",") if s.strip()]
    symbols_c = [s.strip().upper() for s in crypto.split(",") if s.strip()]
    # prefer stock if provided, else crypto
    if symbols_s:
        data_map = ing.fetch_mixed_data(crypto_symbols=[], stock_symbols=symbols_s[:1], period=period, interval=interval)
    else:
        data_map = ing.fetch_mixed_data(crypto_symbols=symbols_c[:1], stock_symbols=[], period=period, interval=interval)

    sym, df = list(data_map.items())[0]

    # 2) Rebuild features to match training
    X, y, feats, processed = build_features(df, horizon=1)

    # 3) Load best model artifact from the last compare run
    #    (If you want it automatic, read the most recent experiments/compare_*.json)
    #    For now, try RF by default and fall back gracefully:
    model_path_candidates = [
        "models/cache/xgb.pkl",
        "models/cache/rf.pkl",
    ]
    model = None
    for p in model_path_candidates:
        if os.path.exists(p):
            model = joblib.load(p)
            break
    if model is None:
        st.error("No saved model found. Run Compare Models first.")
    else:
        # 4) Generate probabilities
        proba = None
        if hasattr(model, "predict_proba"):
            proba = model.predict_proba(X)[:, 1]
        elif hasattr(model, "decision_function"):
            z = model.decision_function(X)
            proba = 1 / (1 + np.exp(-z))
        else:
            # fallback to binary preds
            proba = model.predict(X).astype(float)

        proba_s = pd.Series(proba, index=processed.index[:len(proba)])
        signals = (proba_s >= thr).astype(int)

        # 5) Backtest
        from backtest.backtesting_engine import simulate_long_flat
        metrics, equity, trades = simulate_long_flat(processed["close"], signals)
        st.json(metrics)
        st.line_chart(equity.set_index("date")["equity"])
